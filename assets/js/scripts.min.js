function frmwks_init_editor(e){if(jQuery("#"+e).length){var t=function(e,t){var r;if(e.match("{{")){for(;null!=(r=e.next())&&("}"!=r||"}"!=e.next()););return e.eat("}"),"mustache"}if(e.match("%")){for(;null!=(r=e.next())&&"%"!=r;);return e.eat("%"),"command"}for(;null!=e.next()&&!e.match("{{",!1)&&!e.match("%",!1););return null},r={lineNumbers:!0,matchBrackets:!0,tabSize:2,indentUnit:2,indentWithTabs:!0,enterMode:"keep",tabMode:"shift",lineWrapping:!0,extraKeys:{"Ctrl-Space":"autocomplete"}};return CodeMirror.defineMode("mustache",function(e,r){var o={token:t};return CodeMirror.overlayMode(CodeMirror.getMode(e,r.backdrop||"text/html"),o)}),r.mode=jQuery("#"+e).data("mode")?jQuery("#"+e).data("mode"):"mustache",frmwks_code_editor=CodeMirror.fromTextArea(document.getElementById(e),r),frmwks_code_editor.on("keyup",tagFields),frmwks_code_editor.on("blur",function(e){e.save(),jQuery(e.getInputField()).trigger("change")}),frmwks_code_editor}}var formworks_canvas=!1,frmwks_get_config_object,frmwks_record_change,frmwks_canvas_reset,frmwks_canvas_init,frmwks_rebuild_canvas,frmwks_add_node,frmwks_get_default_setting,frmwks_code_editor,frmwks_handle_save,frmwks_rebuild_magics,frmwks_is_view,frmwks_init_magic_tags,frmwks_get_filters,frmwks_config_object={},frmwks_magic_tags=[];jQuery(function(e){frmwks_get_filters=function(t){frmwks_get_config_object(),console.log(frmwks_config_object),frmwks_config_object.filters&&e(t).data({filters:JSON.stringify(frmwks_config_object.filters)})},frmwks_handle_save=function(t){var r;r=e(t.data.success?".updated_notice_box":".error_notice_box"),r.stop().animate({top:32},200,function(){setTimeout(function(){r.stop().animate({top:-175},200)},2e3)})},frmwks_init_magic_tags=function(){var e=jQuery(".magic-tag-enabled");e.each(function(e,t){var r=jQuery(t);if(r.hasClass("magic-tag-init-bound")){var o=r.parent().find(".magic-tag-init");return void(r.is(":visible")?o.show():o.hide())}var i=jQuery('<span class="dashicons dashicons-editor-code magic-tag-init"></span>'),a=jQuery('<span style="position:relative;display:inline-block; width:100%;"></span>');r.is("input")&&i.css("borderBottom","none"),r.hasClass("formworks-conditional-value-field")&&a.width("auto"),i.insertAfter(r),r.addClass("magic-tag-init-bound"),r.is(":visible")?i.show():i.hide()})},frmwks_get_config_object=function(t){e("#formworks-id").trigger("change");for(var r=e(t),o=e("#formworks-live-config").val(),i=e("[required]"),a=!0,n=0;n<i.length;n++)i[n].value.length<=0&&e(i[n]).is(":visible")?(e(i[n]).addClass("formworks-input-error"),a=!1):e(i[n]).removeClass("formworks-input-error");return a&&(formworks_canvas=o),r.data("config",o),a},frmwks_record_change=function(){jQuery(document).trigger("record_change"),jQuery("#formworks-id").trigger("change"),frmwks_config_object&&jQuery("#formworks-field-sync").trigger("refresh")},frmwks_canvas_reset=function(e,t){if("undefined"!=typeof tinymce)for(ed in tinymce.editors)tinymce.editors[ed].remove();return"undefined"!=typeof QTags&&(QTags.buttonsInitDone=!1,QTags.instances={}),!0},frmwks_canvas_init=function(){formworks_canvas||(jQuery("#formworks-main-canvas").on("keydown keyup change","input, select, textarea",function(e){frmwks_config_object=jQuery("#formworks-main-form").formJSON(),jQuery("#formworks-live-config").val(JSON.stringify(frmwks_config_object)).trigger("change")}),frmwks_init_editor(),formworks_canvas=jQuery("#formworks-live-config").val(),frmwks_config_object=JSON.parse(formworks_canvas),"undefined"!=typeof tinymce&&tinymce.on("AddEditor",function(e){e.editor.on("keyup",function(e){this.save(),jQuery(this.targetElm).trigger("keyup")}),e.editor.on("change",function(e){this.save(),jQuery(this.targetElm).trigger("change")})})),e(".color-field").length&&e(".color-field").wpColorPicker({change:function(t){var r=e(this);r.data("target")&&e(r.data("target")).css(r.data("style"),r.val())}}),e(".formworks-group-wrapper").length&&(e(".formworks-group-wrapper").sortable({handle:".sortable-item",start:function(e,t){t.item.data("moved",!0),t.placeholder.css("borderWidth",t.item.css("borderTopWidth")),t.placeholder.css("margin",t.item.css("marginTop"))},update:function(e,t){jQuery("#formworks-id").trigger("change")}}),e(".formworks-fields-list").sortable({handle:".sortable-item",update:function(){jQuery("#formworks-id").trigger("change")}})),frmwks_init_wp_editors(),e("[data-init-change]").trigger("change"),e("[data-auto-focus]").focus().select(),frmwks_rebuild_magics(),jQuery(document).trigger("canvas_init")},frmwks_add_node=function(t,r){var o="nd"+Math.round(99866*Math.random())+Math.round(99866*Math.random()),i=t.split("."),a=i.join(".")+"."+o,n=JSON.parse('{ "_id" : "'+o+'", "_node_point" : "'+a+'" }');r&&"object"==typeof r&&e.extend(!0,n,r);for(var s='{ "'+i.join('": { "')+'" : { "'+o+'" : '+JSON.stringify(n),c=0;c<=i.length;c++)s+="}";var d=JSON.parse(s);e.extend(!0,frmwks_config_object,d)},frmwks_get_default_setting=function(e){var t="nd"+Math.round(99866*Math.random())+Math.round(99866*Math.random()),r=e.trigger?e.trigger:e.params.trigger;r.data("group")?r.data("group"):"nd"+Math.round(99766*Math.random())+Math.round(99866*Math.random());switch(r.data("addNode")&&frmwks_add_node(r.data("addNode"),r.data("nodeDefault")),r.data("removeNode")&&frmwks_config_object[r.data("removeNode")]&&delete frmwks_config_object[r.data("removeNode")],r.data("script")){case"add-to-object":break;case"add-field-node":frmwks_config_object[r.data("slug")][r.data("group")].field||(frmwks_config_object[r.data("slug")][r.data("group")].field={}),frmwks_config_object[r.data("slug")][r.data("group")].field[t]={_id:t,name:"new field",slug:"new_field"},frmwks_config_object.open_field=t}frmwks_rebuild_canvas()},frmwks_rebuild_canvas=function(){jQuery("#formworks-live-config").val(JSON.stringify(frmwks_config_object)),jQuery("#formworks-field-sync").trigger("refresh")},e.widget("custom.catcomplete",e.ui.autocomplete,{_create:function(){this._super(),this.widget().menu("option","items","> :not(.ui-autocomplete-category)")},_renderMenu:function(t,r){var o=this,i="";e.each(r,function(e,r){var a;r.category!=i&&(t.append("<li class='ui-autocomplete-category'>"+r.category+"</li>"),i=r.category),a=o._renderItemData(t,r),r.category&&a.attr("aria-label",r.category+" : "+r.label)})}}),frmwks_rebuild_magics=function(){function t(e){return e.split(/ \s*/)}function r(e){return t(e).pop()}e(".magic-tag-enabled").bind("keydown",function(t){t.keyCode===e.ui.keyCode.TAB&&e(this).catcomplete("instance").menu.active&&t.preventDefault()}).catcomplete({minLength:0,source:function(t,o){frmwks_magic_tags=[];var i="",a=e(".formworks-magic-tags-definitions");if(a.length)for(var n=0;n<a.length;n++){var s;i="Magic Tags",e(a[n]).data("category")&&(i=e(a[n]).data("category"));try{s=JSON.parse(a[n].value)}catch(c){s=[e(a[n]).data("tag")]}var d;for(f=0;f<s.length;f++)d=s[f].split("*"),d[1]&&(d=d[0]+"*"),frmwks_magic_tags.push({label:"{"+d+"}",value:"{"+s[f]+"}",category:i})}o(e.ui.autocomplete.filter(frmwks_magic_tags,r(t.term)))},focus:function(){return!1},select:function(e,r){var o=t(this.value);return o.pop(),o.push(r.item.value),this.value=o.join(" "),!1}})},frmwks_init_wp_editors=function(){if("undefined"!=typeof tinyMCEPreInit){var e,t,r,o,i;if("undefined"!=typeof tinymce)for(t in tinyMCEPreInit.mceInit)if(e=o?tinyMCEPreInit.mceInit[t]=tinymce.extend({},o,tinyMCEPreInit.mceInit[t]):o=tinyMCEPreInit.mceInit[t],i=tinymce.DOM.select("#wp-"+t+"-wrap")[0],(tinymce.DOM.hasClass(i,"tmce-active")||!tinyMCEPreInit.qtInit.hasOwnProperty(t))&&!e.wp_skip_init)try{tinymce.init(e),window.wpActiveEditor||(window.wpActiveEditor=t)}catch(a){}for(r in tinyMCEPreInit.qtInit)try{quicktags(tinyMCEPreInit.qtInit[r]),window.wpActiveEditor||(window.wpActiveEditor=r)}catch(a){}jQuery(".wp-editor-wrap").on("click.wp-editor",function(){this.id&&(window.wpActiveEditor=this.id.slice(3,-5))})}},e(document).on("click",".formworks-card-actions .confirm a",function(t){t.preventDefault();var r=e(this).closest(".formworks-card-content");actions=r.find(".row-actions"),actions.slideToggle(300)}),e(document).on("keyup change",'[data-format="slug"]',function(t){var r=e(this);return r.data("master")&&r.prop("required")&&this.value.length<=0&&"change"===t.type?(this.value=e(r.data("master")).val().replace(/[^a-z0-9]/gi,"_").toLowerCase(),void(this.value.length&&r.trigger("change"))):void(this.value=this.value.replace(/[^a-z0-9]/gi,"_").toLowerCase())}),e(document).on("keyup change","[data-sync]",function(){var t=e(this),r=e(t.data("sync"));r.each(function(){var r=e(this);r.is("input")?r.val(t.val()).trigger("change"):r.text(t.val())})}),e(document).on("click",".formworks-nav-tabs a",function(t){t.preventDefault();for(var r=e(this),o=r.attr("href"),i=e("[required]"),a=!0,n=0;n<i.length;n++)i[n].value.length<=0&&e(i[n]).is(":visible")?(e(i[n]).addClass("formworks-input-error"),a=!1):e(i[n]).removeClass("formworks-input-error");a&&(frmwks_code_editor&&(frmwks_code_editor.toTextArea(),frmwks_code_editor=!1),e(o).find(".formworks-code-editor").length&&(frmwks_init_editor(e(o).find(".formworks-code-editor").prop("id")),frmwks_code_editor.refresh(),frmwks_code_editor.focus()),jQuery("#formworks-active-tab").val(o).trigger("change"),frmwks_record_change())}),e(document).on("click","[data-remove-parent]",function(t){var r=e(this),o=r.closest(r.data("removeParent"));(!r.data("confirm")||confirm(r.data("confirm")))&&(o.remove(),frmwks_record_change())}),e(document).on("click","[data-remove-element]",function(t){var r=e(this),o=e(r.data("removeElement"));(!r.data("confirm")||confirm(r.data("confirm")))&&(o.remove(),frmwks_record_change())}),e("body").on("click",".magic-tag-init",function(t){var r=e(this),o=r.prev();o.focus().trigger("init.magic")}),e(document).on("change","[data-live-sync]",function(e){frmwks_record_change()}),e(".wp-baldrick").baldrick({request:ajaxurl,method:"POST",before:function(t){var r=e(t);r.data("addNode")&&!r.data("request")&&r.data("request","frmwks_get_default_setting")}}),window.onbeforeunload=function(e){return formworks_canvas&&formworks_canvas!==jQuery("#formworks-live-config").val()&&!frmwks_is_view?!0:void 0}});